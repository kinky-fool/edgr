#!/usr/bin/env python3

import time
import random
from playsound import playsound
import os

from signal import signal, SIGINT
from sys import exit
import threading

audio_dir = "%s/lib/audio" % os.environ['HOME']

edge_min = 15
edge_max = 90

def main():
  global edge_max, edge_min

  edges = int(input("Number of edges: "))

  warm_ups = [ 6, 6, 6, 6, 6, 9, 9, 9, 9, 12, 12, 15 ]

  time.sleep(random.choice(warm_ups) * 60)

  print("Hands off your cock.")
  play_rand_sound(audio_dir + "/hands-off")

  while edges > 0:
    time.sleep(20 + random.randint(0,20))

    print("Get ready to edge, stroke yourself!")
    play_rand_sound(audio_dir + "/stroke")

    countdowns = [ 15, 15,
                   30, 30, 30,
                   45, 45, 45, 45, 45,
                   60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60,
                   90, 90, 90,
                   120 ]

    time.sleep(random.choice(countdowns))

    laugh = 0
    for foo in range(0,3):
      if random.randint(1,20) == 1:
        laugh = 1

    if laugh != 0:
      play_rand_sound(audio_dir + "/laughs")
      longer = 15
      for foo in range(0,3):
        if random.randint(0,1) == 0:
          longer = longer + random.randint(0,45) + 15
      time.sleep(longer)

    print("Edge for me.")
    play_rand_sound(audio_dir + "/edges")

    start = time.time()

    input("Press Enter once you get to the edge.")

    elapsed = time.time() - start

    print("Hands off your cock.")
    play_rand_sound(audio_dir + "/hands-off")

    time.sleep(2)

    print("Good boy.")
    play_rand_sound(audio_dir + '/good-boy')

    if elapsed > edge_max:
      time.sleep(1)
      print("Too slow, try again.")
      play_rand_sound(audio_dir + "/too-slow")
    else:
      if elapsed > edge_max - 1:
        print("That was close!")
      if elapsed > edge_min:
        edge_max = elapsed
      edges = edges - 1

  # Done!
  print("You may stop stroking your cock.")
  play_rand_sound(audio_dir + '/stop')

def play_rand_sound(directory):
  if os.path.isdir(directory):
    filename = ''

    while not os.path.isfile(directory + '/' + filename):
      filename = random.choice(os.listdir(directory))

    mp3 = directory + '/' + filename
    sound_thread = threading.Thread(target=playsound, args=(mp3,))
    sound_thread.start()

  return

def handler(signal_received, frame):
  print()
  exit(0)

if __name__ == '__main__':
  # Run handler() when SIGINT received
  signal(SIGINT, handler)

  main()
