#!/bin/bash

min=50
max=180

RANDOM=$$$(date +%s)


program="/tmp/ctronome.$$"

main() {
  count=20
  if [[ "$1" =~ ^[0-9][0-9]*$ ]]; then
    count=$1
  fi

  half=$((count / 2))
  count=$((count + RANDOM%half - RANDOM%half))

  pace=$((RANDOM%$((max - min)) + min))
  direction='down'
  if [[ $((RANDOM%3)) ]]; then
    direction='up'
  fi
  race_to_max=0
  drop_to_half=0

  for i in $(seq 1 $count); do
    builds=(5 5 5 5 10 10 15 15 30 45 60)
    steadies=(5 10 15 15 30 30 30 45 45 60)

    range=$((max - min))
    quarter_pace=$(((range / 4) + min))
    if [[ "$direction" == 'up' ]]; then
      if [[ "$pace" -gt $((quarter_pace * 3)) ]]; then
        if [[ $((RANDOM%3)) -eq 0 ]]; then
          direction='down'
        fi
      fi
      if [[ $((RANDOM%12)) -eq 0 ]]; then
        direction='down'
      fi
      if [[ "$pace" -ge "$max" ]]; then
        direction='down'
        builds=(5 5 5 10 10 15 15)
      fi
    else
      if [[ "$pace" -le $((quarter_pace * 2)) ]]; then
        if [[ $((RANDOM%3)) -eq 0 ]]; then
          direction='up'
        fi
      fi
      if [[ $((RANDOM%6)) -eq 0 ]]; then
        direction='up'
      fi
      if [[ "$pace" -le "$min" ]]; then
        direction='up'
      fi
    fi

    delta=10
    for i in $(seq 1 $((RANDOM%2 + 2))); do
      delta=$((delta + RANDOM%10 + 1))
    done

    new_pace=$((pace + delta))
    if [[ "$direction" == 'down' ]]; then
      new_pace=$((pace - delta))
    fi

    if [[ $((RANDOM%6)) -eq 0 ]]; then
      if [[ $((RANDOM%100)) -gt $(((pace - min) / range)) ]]; then
        new_pace=$max
      fi
      if [[ $pace -le $quarter_pace ]]; then
        new_pace=$max
      fi
      if [[ $((RANDOM%100)) -gt $(((range - (pace - min)) / range)) ]]; then
        new_pace=$(((range / 2) + min))
      fi
    fi

    if [[ $new_pace -ge $max ]]; then
      new_pace=$max
      builds=(3 3 5 5 5 10 10 15)
      steadies=(10 10 10 15 15 15 30 30 60)
    fi

    if [[ $new_pace -le $min ]]; then
      new_pace="$min"
      min=$((min + 10))
    fi

    build=${builds[$RANDOM % ${#builds[@]}]}
    steady=${steadies[$RANDOM % ${#steadies[@]}]}

    echo "# start: $pace end: $new_pace period: ${build}s steady: ${steady}s"
    change-pace -s $pace -e $new_pace -p $build -S $steady
    pace=$new_pace
  done
}

main "$@"

#for i in $(seq 1 6); do
#  if [[ $((RANDOM%3)) -ne 0 ]]; then
#    for i in $(seq 1 $((RANDOM%5+2))); do
#      main
#    done
#    # Green Light
#    printf "# Green Light\n5 350/4 2/8\n1 120/4 2/8\n5 350/4 2/8\n"
#    for i in $(seq 1 $((RANDOM%2+1))); do
#      main
#    done
#    # Yellow Light
#    printf "# Yellow Light\n5 350/4 2/8\n1 120/4 2/8\n"
#  fi
#done
