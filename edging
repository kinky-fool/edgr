#!/bin/bash

right=5
if [[ -n "$1" ]]; then
  if [[ "$1" =~ ^[0-9]*$ ]]; then
    right="$1"
  fi
fi


wrong=10
if [[ -n "$2" ]]; then
  if [[ "$2" =~ ^[0-9]*$ ]]; then
    wrong="$2"
  fi
fi

win_streak=1
if [[ -n "$3" ]]; then
  if [[ "$3" =~ ^[0-9]*$ ]]; then
    win_streak="$3"
  fi
fi

lose_streak=5
if [[ -n "$4" ]]; then
  if [[ "$4" =~ ^[0-9]*$ ]]; then
    lose_streak="$4"
  fi
fi

score=60
if [[ -n "$5" ]]; then
  if [[ "$5" =~ ^[0-9]*$ ]]; then
    score="$5"
  fi
fi

delay=20

for i in $(seq 1 $win_streak); do
  if [[ $((RANDOM%2)) -eq 1 ]]; then
    delay=$((delay + 3))
  fi
done

delay=$(printf "%0.2g" "$(echo "(16 + 2 * $win_streak) / 10" | bc -l)")

config="$HOME/.config/geeqie/geeqierc.xml"
sed -rie "s/(slideshow.delay\s*=).*$/\1 \"$delay\"/" "$config"
sed -rie "s/(slideshow.repeat\s*=).*/\1 \"true\"/" "$config"

#config="$HOME/.config/mirage/miragerc"
#sed -rie "s/^(slideshow_delay =).*$/\1 $delay/" "$config"

img_dst=/tmp/edging
mkdir -p "$img_dst"

seed=$(((right + wrong) * 5))

safe="$right + ($win_streak * 10)"
safe=$(printf "%.0f" $(echo "$safe" | bc -l))

edge="($lose_streak * $wrong * ((100 - $score) / 100))"
edge="$wrong + ($lose_streak * 15)"
edge=$(printf "%.0f" $(echo "$edge" | bc -l))

$HOME/toys/sexy-slideshow $safe $edge $seed 0 &
pid=$!

seconds=$(printf "%.0f" \
  $(echo "$lose_streak * 30 * ((100 - $score) / 100)" | bc -l))
echo "$seconds"

for i in $(seq 1 $seconds); do
  sleep 1
  if ! ps $pid &>/dev/null; then
    break
  fi
done

if ps $pid &>/dev/null; then
  kill $pid
fi

# clean up
sed -rie "s/(slideshow.repeat\s*=).*/\1 \"false\"/" "$config"
rm -rf "$img_dst"
