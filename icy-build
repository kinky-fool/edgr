#!/bin/bash

image=$1
delay=$2

delay_int=$(printf "%.0f" "$delay")
if [[ $(echo "$delay_int == $delay" | bc) -eq 0 ]]; then
  delay_int=$((delay_int + 1))
fi

count_file=/tmp/icy-count
message=
source ~/.config/sexy-slideshow

if [[ ! -e "$count_file" ]]; then
  printf '0\n' > "$count_file"
fi

now=$(date +"%s")
last=$(stat -c "%Y" "$count_file")
count=$(cat "$count_file")
#timeout=$((delay_int * (3 + ( (10 - count) / 2 ) ) ))
timeout=$((delay_int * (3 + (10 - count))))

passed=$((now - last))
while [[ $passed -gt $timeout && $count -gt 0 ]]; do
  count=$((count - 1))
  passed=$((passed - timeout))
  timeout=$(((delay_int * (3 + (10 - count))) / 4))
done

extend=0
for dir in $edge_pics $safe_pics; do
  if [[ "${image%/*}" == "${dir%/*}" ]]; then
    extend=1
    lube=1
  fi
done

edge=0
for dir in $edge_pics; do
  if [[ "${image%/*}" == "${dir%/*}" ]]; then
    edge=1
  fi
done

message=
# Not in loop above; could increment count for more than iteration
if [[ $edge -eq 1 ]]; then
  count=$((count + 1))
fi

if [[ $lube -eq 1 ]]; then
  if [[ $count -le 10 ]]; then
    chances=(85 60 40 25 15 10 15 25 40 60 85 115 150)
    chance=${chances[$count]}
    if [[ $edge -eq 0 ]]; then
      chance=$((chance * 5 / 4))
    fi
    if [[ $((RANDOM % chance)) -eq 1 ]]; then
      message='lube up your cock'
      newcount=0
      for i in $(seq 1 $(((RANDOM%2)+1))); do
        newcount=$((newcount + (RANDOM % (count-newcount+1))))
      done
      count=$newcount
    fi
  else
    roll=$((RANDOM%8))
    if [[ $roll -eq 1 ]]; then
      message='apply lots of Icy Hot'
    else
      message='apply Icy Hot'
    fi
    if [[ $roll -eq $((RANDOM%8)) ]]; then
      message="${message}...\n    ...and don't forget your balls"
    fi
    if [[ $((RANDOM % 8)) -eq 1 ]]; then
      count=$((RANDOM % (count + 1)))
    else
      count=0
    fi
  fi
fi

if [[ -n "$message" ]]; then
  echo -e "  Mistress says $message"
elif [[ $count -gt 0 ]]; then
  printf '  %i\n' $count
fi

if [[ $extend -eq 1 ]]; then
  printf '%i\n' $count > "$count_file"
fi
