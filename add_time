#!/bin/bash

image="$1"
pics_count="$2"
pics="$3"
start_pics="$4"
max=$((start_pics * 3))

base_image="${image##*/}"

remains_file="$HOME/.edge_remains"
if [[ ! -e "$remains_file" ]]; then
  echo 0 > "$remains_file"
fi

countdown=10

edge_after=$(< "$pics_count")
remains=$(< "$remains_file")

edge=0
if [[ "$edge_after" -ge "$max" ]] || [[ "$edge_after" -le 0 ]]; then
  edge=1
fi

points=$(echo "$image" | grep -Eo '[0-9]+pts' | sed -e 's/pts$//')
if [[ "$points" =~ ^[0-9]+$ ]] && [[ "$points" -gt 0 ]]; then
  new_pics=$(((remains + points) * pics))
  # images that are worth points
  if [[ "$edge" -ne 0 ]]; then
    edge_after=$((new_pics * 2))
  else
    edge_after=$((edge_after + new_pics))
  fi
else
  points=0
fi

if [[ "$points" -gt 0 ]]; then
  if [[ "$edge" -ne 0 ]]; then
    echo "$(((points * 3) + remains))" > "$remains_file"
    edge=0
  else
    echo "$(((points * 2) + remains))" > "$remains_file"
  fi
else
  if [[ "$edge" -ne 0 ]]; then
    echo "$((remains + 1))" > "$remains_file"
  else
    if [[ "$remains" -gt 0 ]]; then
      echo "$((remains - 1))" > "$remains_file"
    fi
  fi
fi

if [[ "$edge" -ne 0 ]]; then
  printf "edge\n"
fi

if [[ "$points" -gt 0 ]] || \
  [[ "$edge_after" -le "$countdown" ]] && [[ "$edge_after" -gt 0 ]]; then
  printf "%4i\n" "$edge_after"
fi

edge_after=$((edge_after - 1))
echo "$edge_after" > "$pics_count"
